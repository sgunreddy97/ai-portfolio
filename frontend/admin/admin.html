<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Sai's Portfolio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-card {
            background: rgba(20, 20, 30, 0.9);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(0, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            width: 400px;
        }

        .login-card h2 {
            color: #00ffff;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #888;
        }

        input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 16px;
        }

        input:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #00ffff, #0088ff);
            color: #0a0a0f;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.3);
        }

        .dashboard {
            display: none;
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(20, 20, 30, 0.9);
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 255, 255, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(20, 20, 30, 0.9);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(0, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.1);
        }

        .stat-value {
            font-size: 2.5em;
            color: #00ffff;
            font-weight: bold;
        }

        .stat-label {
            color: #888;
            margin-top: 10px;
        }

        .data-section {
            background: rgba(20, 20, 30, 0.9);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 255, 255, 0.1);
        }

        .data-section h3 {
            color: #00ffff;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            color: #00ffff;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, #00ffff, #0088ff);
            color: #0a0a0f;
            font-weight: bold;
        }

        .error-msg {
            color: #ff4444;
            text-align: center;
            margin-top: 10px;
        }

        .success-msg {
            color: #00ff88;
            text-align: center;
            margin-top: 10px;
        }

        /* --- Added CSS for full conversation UI --- */

        .conversation-row {
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .conversation-row:hover {
            background: rgba(0, 255, 255, 0.05);
        }
        
        .full-conversation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .conversation-content {
            background: rgba(20, 20, 30, 0.98);
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #00ffff;
        }
        
        .message-full {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .user-message-full {
            background: rgba(0, 255, 136, 0.1);
            border-left: 3px solid #00ff88;
        }
        
        .bot-message-full {
            background: rgba(0, 255, 255, 0.1);
            border-left: 3px solid #00ffff;
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h2>Admin Access</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="Enter admin password">
                </div>
                <button type="submit" class="btn">Login</button>
                <div id="loginMessage"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="header">
            <h1>Portfolio Analytics Dashboard</h1>
            <button class="btn" onclick="logout()" style="width: auto; padding: 10px 20px;">Logout</button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalVisitors">0</div>
                <div class="stat-label">Total Visitors</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalMessages">0</div>
                <div class="stat-label">Contact Messages</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalChats">0</div>
                <div class="stat-label">Chat Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="resumeDownloads">0</div>
                <div class="stat-label">Resume Downloads</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="showTab('messages')">Messages</div>
            <div class="tab" onclick="showTab('conversations')">Conversations</div>
            <div class="tab" onclick="showTab('analytics')">Analytics</div>
        </div>

        <!-- Messages Section -->
        <div class="data-section" id="messagesSection">
            <h3>Contact Messages</h3>
            <table id="messagesTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Subject</th>
                        <th>Message</th>
                    </tr>
                </thead>
                <tbody id="messagesBody">
                    <tr><td colspan="5">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Conversations Section -->
        <div class="data-section" id="conversationsSection" style="display: none;">
            <h3>Chat Conversations</h3>
            <table id="conversationsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Session ID</th>
                        <th>User Message</th>
                        <th>Bot Response</th>
                        <th>Mode</th>
                    </tr>
                </thead>
                <tbody id="conversationsBody">
                    <tr><td colspan="5">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Analytics Section -->
        <div class="data-section" id="analyticsSection" style="display: none;">
            <h3>Analytics Overview</h3>
            <div id="analyticsContent">
                <p>Loading analytics data...</p>
            </div>
        </div>
    </div>

    <script>
        // Remove auto-login check
        // let authToken = localStorage.getItem('adminToken');
        let authToken = null; // Always start logged out

        // Remove this check
        // if (authToken) {
        //     showDashboard();
        // }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');
            
            try {
                const response = await fetch('https://ai-portfolio-backend-abgwf4e6gvckbref.eastus2-01.azurewebsites.net/api/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    // Don't save to localStorage for security
                    // localStorage.setItem('adminToken', authToken);
                    messageDiv.innerHTML = '<div class="success-msg">Login successful!</div>';
                    setTimeout(() => showDashboard(), 500);
                } else {
                    messageDiv.innerHTML = '<div class="error-msg">Invalid password</div>';
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="error-msg">Connection error. Is the backend running?</div>';
            }
        });

        function showDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            loadDashboardData();
        }

        async function loadDashboardData() {
            // Load all data
            loadMessages();
            loadConversations();
            loadAnalytics();
            loadStats();
        }

        async function loadMessages() {
            try {
                const response = await fetch('https://ai-portfolio-backend-abgwf4e6gvckbref.eastus2-01.azurewebsites.net/api/messages', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const data = await response.json();
                const tbody = document.getElementById('messagesBody');
                
                if (data.messages && data.messages.length > 0) {
                    tbody.innerHTML = data.messages.map(msg => `
                        <tr>
                            <td>${new Date(msg.timestamp).toLocaleDateString()}</td>
                            <td>${msg.name}</td>
                            <td>${msg.email}</td>
                            <td>${msg.subject}</td>
                            <td>${msg.message}</td>
                        </tr>
                    `).join('');
                    
                    document.getElementById('totalMessages').textContent = data.messages.length;
                } else {
                    tbody.innerHTML = '<tr><td colspan="5">No messages yet</td></tr>';
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // ---------- UPDATED: loadConversations to show complete content ----------
        async function loadConversations() {
            try {
                const response = await fetch('https://ai-portfolio-backend-abgwf4e6gvckbref.eastus2-01.azurewebsites.net/api/conversations?limit=2000', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const data = await response.json();
                const tbody = document.getElementById('conversationsBody');
                
                if (data.conversations && data.conversations.length > 0) {
                    tbody.innerHTML = data.conversations.map((conv, index) => `
                        <tr class="conversation-row" onclick="showFullConversation(${index})">
                            <td>${new Date(conv.timestamp).toLocaleString()}</td>
                            <td title="${conv.session_id}">${conv.session_id.substring(0, 8)}...</td>
                            <td style="color: #00ff88; max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                                ${escapeHtml(conv.user_message)}
                            </td>
                            <td style="color: #00ffff; max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                                ${escapeHtml((conv.bot_response || '').substring(0, 100))}...
                            </td>
                            <td>${conv.mode || 'strict'}</td>
                        </tr>
                    `).join('');
                    
                    // Store conversations for modal viewing
                    window.conversationsData = data.conversations;
                    
                    document.getElementById('totalChats').textContent = data.conversations.length;
                } else {
                    tbody.innerHTML = '<tr><td colspan="5">No conversations yet</td></tr>';
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        // ---------- UPDATED: modal to display full conversation ----------
        function showFullConversation(index) {
            const conv = window.conversationsData[index];
            if (!conv) return;
            
            const modal = document.createElement('div');
            modal.className = 'full-conversation-modal';
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            modal.innerHTML = `
                <div class="conversation-content">
                    <h2 style="color: #00ffff; margin-bottom: 20px;">
                        Full Conversation Details
                    </h2>
                    
                    <div style="margin-bottom: 20px; color: #888;">
                        <strong>Session ID:</strong> ${conv.session_id}<br>
                        <strong>Timestamp:</strong> ${new Date(conv.timestamp).toLocaleString()}<br>
                        <strong>Mode:</strong> ${conv.mode || 'strict'}<br>
                        ${conv.sentiment ? `<strong>Sentiment:</strong> ${(conv.sentiment * 100).toFixed(0)}% positive<br>` : ''}
                        ${conv.topics ? `<strong>Topics:</strong> ${conv.topics}<br>` : ''}
                    </div>
                    
                    <div class="message-full user-message-full">
                        <strong style="color: #00ff88;">User Message:</strong><br>
                        ${escapeHtml(conv.user_message)}
                    </div>
                    
                    <div class="message-full bot-message-full">
                        <strong style="color: #00ffff;">Bot Response:</strong><br>
                        ${escapeHtml(conv.bot_response)}
                    </div>

                    <button onclick="viewThread('${conv.session_id}')"
                            style="margin-top: 20px; padding: 10px 30px;
                                background: linear-gradient(135deg, #ffaa00, #ff5500);
                                color: #0a0a0f; border: none; border-radius: 10px;
                                cursor: pointer; font-weight: bold; margin-right: 10px;">
                      View Thread
                    </button>
                    
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="margin-top: 20px; padding: 10px 30px; 
                                   background: linear-gradient(135deg, #00ffff, #0088ff); 
                                   color: #0a0a0f; border: none; border-radius: 10px; 
                                   cursor: pointer; font-weight: bold;">
                        Close
                    </button>
                    
                    <button onclick="exportConversation(${index})" 
                            style="margin-left: 10px; padding: 10px 30px; 
                                   background: linear-gradient(135deg, #00ff88, #00cc66); 
                                   color: #0a0a0f; border: none; border-radius: 10px; 
                                   cursor: pointer; font-weight: bold;">
                        Export
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ---------- NEW: export a single conversation ----------
        function exportConversation(index) {
            const conv = window.conversationsData[index];
            if (!conv) return;
            
            const content = `Conversation Export
========================
Session ID: ${conv.session_id}
Timestamp: ${new Date(conv.timestamp).toLocaleString()}
Mode: ${conv.mode || 'strict'}

USER MESSAGE:
${toTemplateSafe(conv.user_message)}

BOT RESPONSE:
${toTemplateSafe(conv.bot_response)}
`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversation_${conv.session_id.substring(0, 8)}_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function loadAnalytics() {
            try {
                const response = await fetch('https://ai-portfolio-backend-abgwf4e6gvckbref.eastus2-01.azurewebsites.net/api/analytics?period=week', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const data = await response.json();
                const content = document.getElementById('analyticsContent');
                
                if (data.data) {
                    content.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${data.data.summary?.total_visitors || 0}</div>
                                <div class="stat-label">Visitors This Week</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.data.summary?.total_page_views || 0}</div>
                                <div class="stat-label">Page Views</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.data.metrics?.bounce_rate || 0}%</div>
                                <div class="stat-label">Bounce Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.data.real_time?.active_users || 0}</div>
                                <div class="stat-label">Active Now</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function loadStats() {
            // This would load from your database
            // For now, using placeholder data
            document.getElementById('totalVisitors').textContent = '127';
            document.getElementById('resumeDownloads').textContent = '23';
        }

        function showTab(tabName) {
            // Hide all sections
            document.getElementById('messagesSection').style.display = 'none';
            document.getElementById('conversationsSection').style.display = 'none';
            document.getElementById('analyticsSection').style.display = 'none';
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected section and activate tab
            if (tabName === 'messages') {
                document.getElementById('messagesSection').style.display = 'block';
                document.querySelectorAll('.tab')[0].classList.add('active');
            } else if (tabName === 'conversations') {
                document.getElementById('conversationsSection').style.display = 'block';
                document.querySelectorAll('.tab')[1].classList.add('active');
            } else if (tabName === 'analytics') {
                document.getElementById('analyticsSection').style.display = 'block';
                document.querySelectorAll('.tab')[2].classList.add('active');
            }
        }

        // Update logout to clear token
        function logout() {
            authToken = null;
            // localStorage.removeItem('adminToken');
            location.reload();
        }
                    
            function escapeHtml(s) {
            const d = document.createElement('div'); d.textContent = String(s ?? ''); return d.innerHTML;
            }
            async function viewThread(sessionId) {
            try {
                const res = await fetch(`https://ai-portfolio-backend-abgwf4e6gvckbref.eastus2-01.azurewebsites.net/api/conversations/${encodeURIComponent(sessionId)}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                const c = document.getElementById('threadContainer');
                if (!c) return;

                c.style.display = 'block';
                if (!data.success || !data.items?.length) {
                c.innerHTML = `<h3>Conversation Thread</h3><p>No messages found in this session.</p>`;
                return;
                }

                c.innerHTML = `
                <h3>Conversation Thread — ${sessionId}</h3>
                ${data.items.map(item => `
                    <div style="padding:12px;border:1px solid #2a2a3a;border-radius:10px;margin-bottom:12px">
                    <div style="opacity:.7;margin-bottom:6px">${new Date(item.timestamp).toLocaleString()}</div>
                    <div><strong>User:</strong> ${escapeHtml(item.user)}</div>
                    <div style="margin-top:6px"><strong>Bot:</strong> ${escapeHtml(item.bot)}</div>
                    </div>
                `).join('')}
                `;
            } catch (e) {
                console.error(e);
                alert('Failed to load thread');
            }
        }
        function toTemplateSafe(s) {
            s = String(s ?? '');
            // escape backticks and backslashes, and neutralize `${`
            return s.replace(/[`\\]/g, '\\$&').replace(/\$\{/g, '\\${');
            }
    </script>
    <div id="threadContainer" class="data-section" style="display:none; margin: 20px 0;"></div>
</body>
</html>
